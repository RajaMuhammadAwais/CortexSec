from typing import List
from ai_pentest.core.agent import BaseAgent, PentestContext
from ai_pentest.llm.base import BaseLLM
from rich.progress import Progress, SpinnerColumn, TextColumn

class SupervisorAgent(BaseAgent):
    """
    The "Boss" agent that orchestrates the pentest workflow.
    """
    def __init__(self, llm: BaseLLM, agents: List[BaseAgent]):
        super().__init__("Supervisor", llm)
        self.agents = {agent.name: agent for agent in agents}

    def run(self, context: PentestContext) -> PentestContext:
        self.log(f"Starting orchestration for {context.target}")
        
        with Progress(
            SpinnerColumn(),
            TextColumn("[progress.description]{task.description}"),
            transient=True,
        ) as progress:
            # Define the workflow sequence
            workflow = [
                ("Reconnaissance", "ReconAgent"),
                ("Scanning", "ScanAgent"),
                ("Vulnerability Analysis", "VulnAnalysisAgent"),
                ("Risk Assessment", "RiskAgent"),
                ("Reporting", "ReportAgent"),
            ]

            for description, agent_name in workflow:
                if agent_name in self.agents:
                    task_id = progress.add_task(f"[cyan]{description}...", total=1)
                    try:
                        context = self.agents[agent_name].run(context)
                        progress.update(task_id, completed=1, description=f"[green]{description} Complete")
                    except Exception as e:
                        self.log(f"Error in {agent_name}: {str(e)}")
                        progress.update(task_id, completed=1, description=f"[red]{description} Failed")
                else:
                    self.log(f"Agent {agent_name} not found, skipping...")
        
        self.log("Pentest workflow completed.")
        return context
