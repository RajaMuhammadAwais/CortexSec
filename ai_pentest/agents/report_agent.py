from ai_pentest.core.agent import BaseAgent, PentestContext
import os

class ReportAgent(BaseAgent):
    """
    Agent responsible for generating the final report.
    """
    def __init__(self, llm):
        super().__init__("ReportAgent", llm)

    def run(self, context: PentestContext) -> PentestContext:
        self.log("Generating professional consultant-grade report...")
        
        findings_data = []
        for f in context.findings:
            findings_data.append({
                "title": f.title,
                "severity": f.severity,
                "description": f.description,
                "mitigation": f.mitigation,
                "owasp": f.owasp_mapping,
                "mitre": f.mitre_mapping
            })
        
        report_prompt = f"""
        Generate a professional, consultant-grade penetration testing report for {context.target}.
        
        Findings Data:
        {findings_data}
        
        The report should include:
        1. Executive Summary: High-level overview for management.
        2. Methodology: Explain the multi-agent AI approach.
        3. Risk Scoring: Explain the severity levels.
        4. Detailed Findings: For each finding, include Title, Severity, Description, Remediation Guidance, and Compliance Context (OWASP/MITRE).
        5. Conclusion.
        
        Format the report in professional Markdown.
        """
        
        report_md = self.llm.generate(report_prompt, system_prompt="You are a professional cybersecurity consultant.")
        
        report_path = "reports/pentest_report.md"
        os.makedirs("reports", exist_ok=True)
        with open(report_path, "w") as f:
            f.write(report_md)
            
        self.log(f"Report generated successfully at {report_path}")
        return context
