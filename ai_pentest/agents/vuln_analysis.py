from ai_pentest.core.agent import BaseAgent, PentestContext, Finding
from typing import List

class VulnAnalysisAgent(BaseAgent):
    """
    Agent responsible for analyzing data for vulnerabilities.
    """
    def __init__(self, llm):
        super().__init__("VulnAnalysisAgent", llm)

    def run(self, context: PentestContext) -> PentestContext:
        self.log("Analyzing data for vulnerabilities...")
        
        analysis_prompt = f"""
        Based on the reconnaissance data:
        {context.recon_data}
        
        Identify potential vulnerabilities. For each vulnerability, provide:
        - Title
        - Description
        - Severity (Low, Medium, High, Critical)
        - Confidence (0.0 to 1.0)
        - Evidence (why you think this exists)
        - Mitigation
        - OWASP Top 10 Mapping
        - MITRE ATT&CK Mapping
        
        Return a list of findings in JSON format.
        """
        
        results = self.llm.generate_json(analysis_prompt, system_prompt="You are a senior vulnerability researcher.")
        
        if "findings" in results:
            for f_data in results["findings"]:
                finding = Finding(
                    title=f_data.get("title", "Unknown"),
                    description=f_data.get("description", ""),
                    severity=f_data.get("severity", "Low"),
                    confidence=f_data.get("confidence", 0.5),
                    evidence=f_data.get("evidence", ""),
                    mitigation=f_data.get("mitigation", ""),
                    owasp_mapping=f_data.get("owasp_mapping"),
                    mitre_mapping=f_data.get("mitre_mapping")
                )
                context.findings.append(finding)
        
        self.log(f"Analysis complete. Found {len(context.findings)} potential issues.")
        return context
