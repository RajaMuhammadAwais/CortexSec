from urllib.parse import urlparse
from ai_pentest.core.agent import BaseAgent, PentestContext


class AttackSurfaceAgent(BaseAgent):
    """Builds a simple attack-surface model from recon data."""

    def __init__(self, llm):
        super().__init__("AttackSurfaceAgent", llm)

    def run(self, context: PentestContext) -> PentestContext:
        parsed = urlparse(context.target)
        headers = context.recon_data.get("raw", {}).get("headers", {})

        exposed_services = []
        if headers.get("Server"):
            exposed_services.append(f"web-server:{headers.get('Server')}")
        if headers.get("X-Powered-By"):
            exposed_services.append(f"app-framework:{headers.get('X-Powered-By')}")

        context.attack_surface = {
            "entry_points": [context.target],
            "host": parsed.hostname,
            "scheme": parsed.scheme,
            "port": parsed.port or (443 if parsed.scheme == "https" else 80),
            "technologies": context.recon_data.get("analysis", {}).get("technologies", []),
            "exposed_services": exposed_services,
        }

        context.history.append({"agent": self.name, "message": "Attack surface modeled"})
        self.log("Attack surface model updated.")
        return context
