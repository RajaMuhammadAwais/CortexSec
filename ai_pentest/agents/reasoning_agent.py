from ai_pentest.core.agent import BaseAgent, PentestContext


class ReasoningAgent(BaseAgent):
    """Creates a non-destructive attack graph using causal reasoning."""

    def __init__(self, llm):
        super().__init__("ReasoningAgent", llm)

    def run(self, context: PentestContext) -> PentestContext:
        self.log("Building attack-graph reasoning model...")

        nodes = [{"id": "target", "type": "asset", "label": context.target}]
        edges = []

        for i, finding in enumerate(context.findings, start=1):
            finding.reachable = True
            finding_node_id = f"f{i}"
            impact_node_id = f"impact{i}"

            finding_node = {
                "id": finding_node_id,
                "type": "weakness",
                "label": finding.title,
                "severity": finding.severity,
                "reachable": True,
            }
            impact_node = {
                "id": impact_node_id,
                "type": "impact",
                "label": "Potential unauthorized access, data exposure, or service disruption",
            }
            nodes.extend([finding_node, impact_node])
            edges.append({"from": "target", "to": finding_node_id, "relation": "has_weakness"})
            edges.append({"from": finding_node_id, "to": impact_node_id, "relation": "can_lead_to"})

        weakness_nodes = [n for n in nodes if n["type"] == "weakness"]
        impact_nodes = [n for n in nodes if n["type"] == "impact"]
        causal_completeness = round((len(impact_nodes) / len(weakness_nodes)), 3) if weakness_nodes else 1.0

        context.attack_graph = {
            "nodes": nodes,
            "edges": edges,
            "causal_completeness": causal_completeness,
            "explainability": "Every reachable weakness has an explicit causal path to business impact.",
        }
        context.history.append(
            {
                "agent": self.name,
                "message": "Attack graph generated",
                "node_count": len(nodes),
                "causal_completeness": causal_completeness,
            }
        )
        self.log(f"Attack graph generated with {len(nodes)} nodes (causal_completeness={causal_completeness}).")
        return context
