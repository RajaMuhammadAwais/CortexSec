from ai_pentest.core.agent import BaseAgent, PentestContext


class ExploitabilityAgent(BaseAgent):
    """
    Validates each reachable finding for real-world impact and exploitability
    using non-destructive causal reasoning.
    """

    def __init__(self, llm):
        super().__init__("ExploitabilityAgent", llm)

    def run(self, context: PentestContext) -> PentestContext:
        self.log("Evaluating real-world impact and exploitability for reachable findings...")

        analyzed = 0
        reachable = 0
        high_priority = []

        for finding in context.findings:
            if not finding.reachable:
                continue

            reachable += 1
            severity = finding.severity.lower()
            cvss = finding.cvss_score or 0.0

            if severity in {"critical", "high"} or cvss >= 7.0:
                exploitability = "Likely exploitable in real environments if preconditions are met. Prioritize immediate remediation."
                impact = "Can lead to meaningful business impact such as data exposure, account compromise, or service disruption."
            elif severity == "medium" or cvss >= 4.0:
                exploitability = "Moderately exploitable when configuration and access conditions align."
                impact = "Can contribute to lateral risk and should be fixed in the near term."
            else:
                exploitability = "Lower exploitability in isolation, but may amplify chained attacks."
                impact = "Limited standalone impact; still relevant for defense-in-depth."

            finding.exploitability_summary = exploitability
            finding.impact_summary = impact
            finding.analyzed = True
            analyzed += 1

            if severity in {"Critical", "High"}:
                high_priority.append(finding.title)

        context.exploitability_assessment = {
            "reachable_findings": reachable,
            "analyzed_findings": analyzed,
            "analysis_ratio": round((analyzed / reachable), 3) if reachable else 1.0,
            "high_priority_findings": high_priority,
            "method": "Non-destructive causal exploitability reasoning",
        }

        context.history.append(
            {
                "agent": self.name,
                "message": "Exploitability and impact analysis completed",
                "analyzed": analyzed,
                "reachable": reachable,
            }
        )
        self.log(f"Exploitability analysis complete for {analyzed}/{reachable} reachable findings.")
        return context
